<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:si-xml="http://www.springframework.org/schema/integration/xml"
	xmlns:si="http://www.springframework.org/schema/integration" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:si-stream="http://www.springframework.org/schema/integration/stream"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd
			http://www.springframework.org/schema/integration/xml
			http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd
			http://www.springframework.org/schema/util
			http://www.springframework.org/schema/util/spring-util.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
			http://www.springframework.org/schema/integration/stream
      		http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd">

	<si:channel id="inboxChannel" />
	<si:filter input-channel="inboxChannel" ref="messageValidator" output-channel="inboxSplitChannel" discard-channel="invalidMessageChannel"/>
	
	<bean id="messageValidator" class="middleware.filter.MessageValidator">
		<constructor-arg ref="selectTotalXpath" />
		<constructor-arg ref="selectItemsXpath" />
		<constructor-arg ref="selectCurrencyModeXpath" />
	</bean>
	
	<si-xml:xpath-expression id="selectTotalXpath" expression="/order/detail/amount/text()" />
	<si-xml:xpath-expression id="selectItemsXpath" expression="//item" />
	<si-xml:xpath-expression id="selectCurrencyModeXpath" expression="/order/detail/currency/text()" />	
	
	<si:channel id="inboxSplitChannel" />
	<si:splitter input-channel="inboxSplitChannel" output-channel="routingChannel" ref="orderSplitter"/>
                  
	<si-xml:xpath-expression id="selectHeadXpath" expression="//head" />
	<si-xml:xpath-expression id="selectDetailXpath" expression="//detail" />
	
	<bean id="orderSplitter" class="middleware.splitter.OrderSplitter">
		<constructor-arg ref="selectHeadXpath" />
		<constructor-arg ref="selectDetailXpath" />
		<constructor-arg ref="selectItemsXpath" />	
	</bean>
	
	<si:channel id="invalidMessageChannel" />
	<si-stream:stdout-channel-adapter id="stdoutAdapter" channel="invalidMessageChannel" append-newline="true"/>
	
	<si:channel id="routingChannel" />
	
	<si-xml:xpath-router id="router" input-channel="routingChannel" default-output-channel="invalidMessageChannel">
	    <si-xml:xpath-expression expression="/order/item/category/text()"/>
	    <si-xml:mapping value="3" channel="redStrawberryChannel"/>
	    <si-xml:mapping value="2" channel="mobileSysChannel"/>
	    <si-xml:mapping value="1" channel="dataSysChannel"/>
	</si-xml:xpath-router>
	
	<si:channel id="redStrawberryChannel" />
	<si-stream:stdout-channel-adapter id="redStrawberryStdoutAdapter" channel="redStrawberryChannel" append-newline="true"/>
	
	<si:channel id="mobileSysChannel" />
	<si-stream:stdout-channel-adapter id="mobileSysStdoutAdapter" channel="mobileSysChannel" append-newline="true"/>
	
	<si:channel id="dataSysChannel" />
	<si-stream:stdout-channel-adapter id="dataSysStdoutAdapter" channel="dataSysChannel" append-newline="true"/>
	
	

<!-- 	<jms:message-driven-channel-adapter id="jmsIn" -->
<!-- 			destination="inboxQueue" -->
<!-- 			channel="inboxChannel" /> -->
			
<!-- 	<jms:message-driven-channel-adapter id="jmsout" -->
<!-- 			destination="outboxQueue" -->
<!-- 			channel="outboxChannel" /> -->


	<!--  convert the order item to a format that can be understood by BigBooks the wholesaler 
	<si-xml:xslt-transformer input-channel="invalidTotalChannel" output-channel="resupplyOrderChannel" 
			xsl-resource="classpath:/META-INF/spring/integration/bigBooksSupplierTransformer.xsl"/>

	 send the resupply order
	<si:outbound-channel-adapter method="orderResupply" channel="resupplyOrderChannel">
		<bean class="org.springframework.integration.samples.xml.ExternalResupply" />
	</si:outbound-channel-adapter> -->

</beans>
